"use strict";angular.module("lilybook",["ngAnimate","ngRoute","ngSanitize","ngTouch","ui.bootstrap"]).config(["$routeProvider","$locationProvider","$sceDelegateProvider",function(a,b,c){b.html5Mode(!0).hashPrefix("!"),c.resourceUrlWhitelist(["self","*://www.youtube.com/**"]),a.when("/",{templateUrl:"views/splash.html",controller:"SplashCtrl",controllerAs:"splash"}).when("/about",{templateUrl:"views/about.html",controller:"AboutCtrl"}).when("/login",{templateUrl:"views/login.html"}).when("/signup",{templateUrl:"views/signup.html"}).when("/home",{templateUrl:"views/home.html",controller:"HomeCtrl",controllerAs:"home",resolve:{auth:["userSvc",function(a){return a.isAuthenticated()}]}}).when("/composers",{templateUrl:"views/composers.html",controller:"ComposersCtrl",controllerAs:"composers",resolve:{auth:["userSvc",function(a){return a.isAuthenticated()}]}}).when("/composer/:vanity",{templateUrl:"views/composer.html",controller:"ComposerCtrl",controllerAs:"composer"}).when("/composition/:title/:id",{templateUrl:"views/composition.html",controller:"CompositionCtrl",controllerAs:"composition"}).otherwise({redirectTo:"/"})}]),angular.module("lilybook").controller("AddComposerCtrl",["$location","$modalInstance","composerSvc",function(a,b,c){var d=this;d.root=a.protocol()+"://"+a.host()+"/",d.submit=function(){c.getComposer(d.vanity).then(function(a){a?alert("vanity exist!"):c.createComposer({vanity:d.vanity,fullname:d.fullname,image:d.image,description:d.description}).then(function(){b.close()})})}}]),angular.module("lilybook").controller("ComposerCtrl",["$routeParams","composerSvc","compositionSvc",function(a,b,c){var d=this;b.getComposer(a.vanity).then(function(a){console.log(a),d.composer=a,c.getCompositionsByComposer(a).then(function(a){console.log(a),d.compositions=a})})}]),angular.module("lilybook").controller("ComposersCtrl",["$modal","composerSvc",function(a,b){var c=this;c.open=function(){a.open({templateUrl:"views/modals/add-composer.html",size:"lg",controller:"AddComposerCtrl",controllerAs:"addComposer",backdrop:"static"})},b.getComposers(0,20).then(function(a){c.list=a})}]),angular.module("lilybook").controller("CompositionCtrl",["$routeParams","compositionSvc","videoSvc",function(a,b,c){var d=this;b.getCompositionById(a.id).then(function(a){console.log(a),d.composition=a,c.getVideosByComposition(a).then(function(a){console.log(a),d.videos=a})})}]),angular.module("lilybook").controller("HomeCtrl",function(){}),angular.module("lilybook").controller("MainCtrl",["$rootScope","$location","userSvc",function(a,b,c){var d=this;Parse.initialize("fHO4LtJRfsdhQBBicYZpdpj3BQHHQCVEiDPkS4ZI","3gzRyAZnxtQLn1IofC4Layn6cc487e4n5Jin6FzM"),c.current().then(function(b){a.user=b}),d.signup=function(e,f,g,h){c.signUp(e,f,g,h).then(function(c){d.error=null,a.user=c,b.path("/home")},function(a){d.error=a})},d.login=function(e,f){c.logIn(e,f).then(function(c){d.error=null,a.user=c,b.path("/home")},function(a){d.error=a})},d.logout=function(){c.logOut().then(function(){a.user=null,b.path("/")})},a.$on("$routeChangeError",function(a,c,d,e){console.log("$routeChangeError",arguments),"AUTH_REQUIRED"===e&&b.path("/login")})}]),angular.module("lilybook").controller("SplashCtrl",["composerSvc",function(a){var b=this;b.heros=[{image:"images/hero1.jpg",headline:"Example headline.",text:'Note: If you\'re viewing this page via a file:// URL, the "next" and "previous" Glyphicon buttons on the left and right might not load/display properly due to web browser security rules.',action:'<a class="btn btn-lg btn-primary" href="/signup">Sign up today</a>'},{image:"images/hero2.jpg",headline:"Another example headline.",text:"Cras justo odio, dapibus ac facilisis in, egestas eget quam. Donec id elit non mi porta gravida at eget metus. Nullam id",action:'<a class="btn btn-lg btn-primary" href="#">Learn more</a>'},{image:"images/hero3.jpg",headline:"One more for good measure.",text:"dolor id nibh ultricies vehicula ut id elit..",action:'<a class="btn btn-lg btn-primary" href="#">Browse gallery</a>'}],a.getFeaturedComposers().then(function(a){b.composers=a})}]),angular.module("lilybook").factory("composerSvc",["$q",function(a){var b=Parse.Object.extend("Composer"),c=function(a){return{base:a,id:a.id,fullname:a.get("fullName"),shortname:a.get("shortName"),bio:a.get("description"),vanity:a.get("vanity"),image:a.get("image")?a.get("image").url():"",getUrl:function(){return"composer/"+this.vanity}}},d=function(d){var e=a.defer(),f=new b;return f.set("fullName",d.fullname),f.set("shortName",d.shortname),f.set("description",d.bio),f.set("vanity",d.vanity),f.save().then(function(a){e.resolve(c(a))},function(a){e.reject(a)}),e.promise},e=function(d){var e=a.defer(),f=new Parse.Query(b);return f.equalTo("vanity",d),f.first().then(function(a){a?e.resolve(c(a)):e.reject("NOT_FOUND")},function(a){e.reject(a)}),e.promise},f=function(d,e){var f=a.defer(),g=new Parse.Query(b);return g.skip(d||0),g.limit(e||10),g.find().then(function(a){f.resolve(a.map(c))},function(a){f.reject(a)}),f.promise},g=function(){var d=a.defer(),e=new Parse.Query(b);return e.exists("image"),e.ascending("vanity"),e.limit(3),e.find().then(function(a){d.resolve(a.map(c))},function(a){d.reject(a)}),d.promise};return{createComposer:d,getComposer:e,getComposers:f,getFeaturedComposers:g}}]),angular.module("lilybook").factory("compositionSvc",["$q","mapperSvc",function(a,b){var c=Parse.Object.extend("Composition"),d=function(d){var e=a.defer(),f=new Parse.Query(c);return f.equalTo("composer",d.base),f.include("key"),f.include("instrumentation"),f.include("type"),f.find().then(function(a){e.resolve(a.map(b.compositionMapper))},function(a){e.reject(a)}),e.promise},e=function(d){var e=a.defer(),f=new Parse.Query(c);return f.equalTo("objectId",d),f.include("key"),f.include("instrumentation"),f.include("type"),f.include("rcm"),f.include("abrsm"),f.include("henle"),f.include("composer"),f.first().then(function(a){e.resolve(b.compositionMapper(a))},function(a){e.reject(a)}),e.promise};return{getCompositionsByComposer:d,getCompositionById:e}}]),angular.module("lilybook").factory("mapperSvc",function(){var a=function(a){var b=a.split(" ").join("_");return b=b.replace(/,/g,""),b=b.replace(/\./g,""),b=b.replace(/♯/g,"_sharp"),b=b.replace(/♭/g,"_flat"),b.toLowerCase()},b=function(b){return{base:b,id:b.id,title:b.get("title"),opus:b.get("opus"),number:b.get("number"),key:b.get("key").get("name"),instrumentation:b.get("instrumentation").get("name"),type:b.get("type").get("name"),wikipedia:b.get("wikipedia"),imslp:b.get("imslp"),composer:b.get("composer")?c(b.get("composer")):null,rcm:b.get("rcm")?b.get("rcm").get("name"):null,abrsm:b.get("abrsm")?b.get("abrsm").get("name"):null,henle:b.get("henle")?b.get("henle").get("name"):null,getUrl:function(){return"composition/"+a(this.title)+"/"+this.id}}},c=function(a){return{base:a,id:a.id,fullname:a.get("fullName"),shortname:a.get("shortName"),bio:a.get("description"),vanity:a.get("vanity"),image:a.get("image")?a.get("image").url():null,getUrl:function(){return"composer/"+this.vanity}}},d=function(a){return{base:a,id:a.id,embed:a.get("embed"),source:a.get("source"),title:a.get("title")}};return{compositionMapper:b,composerMapper:c,videoMapper:d}}),angular.module("lilybook").factory("userSvc",["$q",function(a){var b=function(){var b=a.defer(),c=Parse.User.current();return b.resolve(c?{uid:c.id,email:c.get("email"),firstname:c.get("firstname"),lastname:c.get("lastname")}:null),b.promise},c=function(b,c,d,e){var f=a.defer();return Parse.User.signUp(b,c,{email:b,firstname:d,lastname:e}).then(function(a){f.resolve({uid:a.id,email:a.get("email"),firstname:a.get("firstname"),lastname:a.get("lastname")})},function(a){f.reject(a)}),f.promise},d=function(b,c){var d=a.defer();return Parse.User.logIn(b,c).then(function(a){d.resolve({uid:a.id,email:a.get("email"),firstname:a.get("firstname"),lastname:a.get("lastname")})},function(a){d.reject(a)}),d.promise},e=function(){var b=a.defer();return Parse.User.logOut().then(function(){b.resolve()},function(a){b.reject(a)}),b.promise},f=function(){var b=Parse.User.current();return b&&b.authenticated()?a.when(!0):a.reject("AUTH_REQUIRED")};return{current:b,signUp:c,logIn:d,logOut:e,isAuthenticated:f}}]),angular.module("lilybook").factory("videoSvc",["$q","mapperSvc",function(a,b){var c=Parse.Object.extend("Video"),d=function(d){var e=a.defer(),f=new Parse.Query(c);return f.equalTo("composition",d.base),f.find().then(function(a){e.resolve(a.map(b.videoMapper))},function(a){e.reject(a)}),e.promise};return{getVideosByComposition:d}}]);